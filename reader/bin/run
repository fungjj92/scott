#!/bin/sh
set -e

if [ -z "$READER_ROOT" ]; then
  echo Activate before running this.
  exit 1
fi

# Download the listing
(
  LISTING_URL='http://www.mvn.usace.army.mil/ops/regulatory/publicnotices.asp?ShowLocationOrder=False'
  cd "$READER_ROOT/../listings"
  wsync "$LISTING_URL" publicnotices.asp html
)

# Parse the listing
(
  cd "$READER_ROOT/../listings"
  listing publicnotices.asp.html web
)


# Download the public notices and drawings
(
  tmp=$(mktemp)
  cd "$READER_ROOT/../listings"
  permits=listing publicnotices.asp.html terminal > $tmp

  while $(( $(wc -l $tmp) > 0 )); do
    tmprow=$(head -n1 $tmp)
    sed -i 1d $tmp

    permitApplicaitonNumber=$(echo $tmprow | cut -d '\t' -f1)
    publicNoticeUrl=$(echo $tmprow | cut -d '\t' -f2)
    drawingsUrl=$(echo $tmprow | cut -d '\t' -f3)

    cd "$READER_ROOT/../documents/$permitApplicationNumber"
    wsync "$publicNoticeUrl" public_notice pdf
    wsync "$drawingsUrl" drawings pdf
  done
)

# Parse the public notice
(
  cd "$READER_ROOT/../documents"
  for permitApplicationNumber in *; do
    (
      cd $permitApplicationNumber
      ls
    )
  done
)
